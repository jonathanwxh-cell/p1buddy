<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P1Buddy ‚Äî Singapore P1 School Registration Planner</title>
  <meta name="description" content="Enter your postal code. See your odds at every nearby primary school. Free P1 registration probability tool for Singapore parents.">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; }
    
    .hero { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 3rem 1rem 2rem; text-align: center; }
    .hero h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .hero p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 1.5rem; }
    
    .search-box { max-width: 500px; margin: 0 auto; display: flex; gap: 0.5rem; }
    .search-box input { flex: 1; padding: 0.875rem 1rem; border: none; border-radius: 0.5rem; font-size: 1rem; outline: none; }
    .search-box button { padding: 0.875rem 1.5rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .search-box button:hover { background: #d97706; }
    
    .container { max-width: 800px; margin: 0 auto; padding: 1.5rem 1rem; }
    
    .phase-check { background: white; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none; }
    .phase-check h3 { margin-bottom: 1rem; font-size: 1.1rem; }
    .phase-check label { display: block; padding: 0.5rem 0; cursor: pointer; }
    .phase-check input[type="radio"] { margin-right: 0.5rem; }
    .phase-result { margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 0.5rem; font-weight: 500; }
    
    .results { display: none; }
    .results h2 { margin-bottom: 0.5rem; }
    .results .subtitle { color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem; }
    
    .school-card { background: white; border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .school-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .school-name { font-size: 1.1rem; font-weight: 600; }
    .school-distance { font-size: 0.85rem; color: #64748b; }
    .distance-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
    .distance-badge.within-1km { background: #dcfce7; color: #166534; }
    .distance-badge.within-2km { background: #fef9c3; color: #854d0e; }
    .distance-badge.outside-2km { background: #fee2e2; color: #991b1b; }
    
    .phase-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .phase-cell { text-align: center; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.8rem; }
    .phase-cell .label { font-weight: 600; margin-bottom: 0.25rem; }
    .phase-cell .odds { font-size: 1.1rem; font-weight: 700; }
    .phase-cell.safe { background: #dcfce7; }
    .phase-cell.moderate { background: #fef9c3; }
    .phase-cell.risky { background: #fee2e2; }
    .phase-cell.na { background: #f1f5f9; color: #94a3b8; }
    
    .history-toggle { color: #3b82f6; cursor: pointer; font-size: 0.85rem; margin-top: 0.5rem; display: inline-block; }
    .history-detail { display: none; margin-top: 0.75rem; font-size: 0.8rem; }
    .history-detail table { width: 100%; border-collapse: collapse; }
    .history-detail th, .history-detail td { padding: 0.375rem 0.5rem; border-bottom: 1px solid #e2e8f0; text-align: center; }
    .history-detail th { background: #f8fafc; font-weight: 600; }
    
    .info-section { background: white; border-radius: 0.75rem; padding: 1.5rem; margin-top: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .info-section h3 { margin-bottom: 0.75rem; }
    .info-section p { color: #475569; font-size: 0.9rem; margin-bottom: 0.5rem; }
    
    .loading { text-align: center; padding: 2rem; display: none; }
    .loading .spinner { display: inline-block; width: 2rem; height: 2rem; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .footer { text-align: center; padding: 2rem 1rem; color: #94a3b8; font-size: 0.8rem; }
    .footer a { color: #3b82f6; text-decoration: none; }
    
    .disclaimer { background: #fffbeb; border: 1px solid #fde68a; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.8rem; color: #92400e; margin-bottom: 1.5rem; display: none; }

    @media (max-width: 640px) {
      .hero h1 { font-size: 1.5rem; }
      .phase-grid { grid-template-columns: repeat(2, 1fr); }
      .search-box { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>üéí P1Buddy</h1>
    <p>Enter your postal code. See your odds at every nearby school.</p>
    <div class="search-box">
      <input type="text" id="postalInput" placeholder="Enter postal code (e.g. 569930)" maxlength="6" inputmode="numeric">
      <button onclick="search()">Find Schools</button>
    </div>
  </div>
  
  <div class="container">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top:1rem;color:#64748b;">Finding schools near you...</p>
    </div>
    
    <div class="disclaimer" id="disclaimer">
      ‚ö†Ô∏è Based on historical data from 2022-2024. Actual results may vary. This tool provides estimates, not guarantees. Always refer to <a href="https://www.moe.gov.sg/primary/p1-registration" target="_blank">MOE's official site</a>.
    </div>

    <div class="phase-check" id="phaseCheck">
      <h3>What phase are you eligible for?</h3>
      <label><input type="radio" name="phase" value="1" onchange="updatePhaseHighlight()"> <strong>Phase 1</strong> ‚Äî Sibling studying in the school</label>
      <label><input type="radio" name="phase" value="2A" onchange="updatePhaseHighlight()"> <strong>Phase 2A</strong> ‚Äî Parent is alumni member / staff / advisory committee</label>
      <label><input type="radio" name="phase" value="2B" onchange="updatePhaseHighlight()"> <strong>Phase 2B</strong> ‚Äî Parent volunteer (‚â•40 hrs) / church-clan member / endorsed by community leader</label>
      <label><input type="radio" name="phase" value="2C" onchange="updatePhaseHighlight()" checked> <strong>Phase 2C</strong> ‚Äî Open to all Singapore Citizens / PRs</label>
      <div class="phase-result" id="phaseResult"></div>
    </div>
    
    <div class="results" id="results">
      <h2>Nearby Primary Schools</h2>
      <p class="subtitle" id="resultsSubtitle"></p>
      <div id="schoolList"></div>
    </div>
    
    <div class="info-section">
      <h3>How does P1 registration work?</h3>
      <p>Singapore P1 registration runs in phases from July-August each year. Priority is given first by phase (sibling > alumni > volunteer > open), then by distance (within 1km > 1-2km > outside 2km), then by citizenship (SC > PR).</p>
      <p>When more applicants than vacancies exist in a priority group, MOE conducts computerized balloting.</p>
      <p><strong>This tool uses 3 years of historical data (2022-2024)</strong> to show you which schools near your home have historically had space, and which ones regularly ballot.</p>
    </div>
  </div>
  
  <div class="footer">
    <p>P1Buddy is a free tool. Not affiliated with MOE.</p>
    <p>Data from <a href="https://www.moe.gov.sg/primary/p1-registration" target="_blank">MOE</a> and <a href="https://www.onemap.gov.sg" target="_blank">OneMap</a>.</p>
  </div>

  <script>
    let schoolsData = null;
    let userLat = null, userLng = null;
    
    // Load data
    fetch('data/schools-combined.json')
      .then(r => r.json())
      .then(d => { schoolsData = d; })
      .catch(e => console.error('Failed to load school data:', e));
    
    document.getElementById('postalInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') search();
    });
    
    async function search() {
      const postal = document.getElementById('postalInput').value.trim();
      if (!/^\d{6}$/.test(postal)) {
        alert('Please enter a valid 6-digit postal code');
        return;
      }
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('results').style.display = 'none';
      
      try {
        // Geocode postal code via OneMap
        const res = await fetch(`https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${postal}&returnGeom=Y&getAddrDetails=Y&pageNum=1`);
        const data = await res.json();
        
        if (!data.found || data.found === 0) {
          alert('Postal code not found. Please check and try again.');
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        userLat = parseFloat(data.results[0].LATITUDE);
        userLng = parseFloat(data.results[0].LONGITUDE);
        
        displayResults(postal);
      } catch(e) {
        alert('Error looking up postal code. Please try again.');
        console.error(e);
      }
      
      document.getElementById('loading').style.display = 'none';
    }
    
    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    function getOddsClass(school, phase) {
      const years = school.history;
      let oversubCount = 0;
      let totalYears = 0;
      
      for (const [year, phases] of Object.entries(years)) {
        if (phases[phase]) {
          totalYears++;
          if (phases[phase].oversubscribed) oversubCount++;
        }
      }
      
      if (totalYears === 0) return { class: 'na', label: 'N/A', desc: 'No data' };
      
      const pct = ((totalYears - oversubCount) / totalYears * 100).toFixed(0);
      if (oversubCount === 0) return { class: 'safe', label: 'üü¢', desc: `Safe ‚Äî no balloting in ${totalYears}yr` };
      if (oversubCount < totalYears) return { class: 'moderate', label: 'üü°', desc: `Balloted ${oversubCount}/${totalYears} years` };
      return { class: 'risky', label: 'üî¥', desc: `Balloted every year (${totalYears}yr)` };
    }
    
    function displayResults(postal) {
      if (!schoolsData) {
        alert('School data still loading, please wait...');
        return;
      }
      
      // Calculate distances and sort
      const withDistance = schoolsData.map(s => ({
        ...s,
        distance: haversine(userLat, userLng, s.lat, s.lng)
      })).sort((a, b) => a.distance - b.distance);
      
      // Show schools within 2km, plus next 5
      const nearby = withDistance.filter(s => s.distance <= 2000);
      const extra = withDistance.filter(s => s.distance > 2000).slice(0, 5);
      const display = [...nearby, ...extra];
      
      document.getElementById('disclaimer').style.display = 'block';
      document.getElementById('phaseCheck').style.display = 'block';
      document.getElementById('results').style.display = 'block';
      document.getElementById('resultsSubtitle').textContent = 
        `${nearby.length} schools within 2km of postal code ${postal}`;
      
      const selectedPhase = document.querySelector('input[name="phase"]:checked')?.value || '2C';
      
      const html = display.map((s, idx) => {
        const distKm = (s.distance / 1000).toFixed(2);
        const band = s.distance <= 1000 ? 'within-1km' : s.distance <= 2000 ? 'within-2km' : 'outside-2km';
        const bandLabel = s.distance <= 1000 ? 'Within 1km' : s.distance <= 2000 ? '1-2km' : 'Outside 2km';
        
        const phases = ['2A', '2B', '2C', '2CS'];
        const phaseCells = phases.map(p => {
          const odds = getOddsClass(s, p);
          return `<div class="phase-cell ${odds.class}">
            <div class="label">${p === '2CS' ? '2C(S)' : p}</div>
            <div class="odds">${odds.label}</div>
            <div style="font-size:0.7rem;margin-top:0.15rem;">${odds.desc}</div>
          </div>`;
        }).join('');
        
        // History table
        const years = Object.keys(s.history).sort();
        const histRows = years.map(y => {
          const cols = phases.map(p => {
            const d = s.history[y]?.[p];
            if (!d) return '<td>-</td>';
            const style = d.oversubscribed ? 'color:#dc2626;font-weight:600' : 'color:#16a34a';
            return `<td style="${style}">${d.applicants}/${d.vacancies}${d.balloted ? ' ‚ö°' : ''}</td>`;
          }).join('');
          return `<tr><td><strong>${y}</strong></td>${cols}</tr>`;
        }).join('');
        
        return `<div class="school-card">
          <div class="school-header">
            <div>
              <div class="school-name">${s.name} Primary School</div>
              <div class="school-distance">${distKm} km away</div>
            </div>
            <span class="distance-badge ${band}">${bandLabel}</span>
          </div>
          <div class="phase-grid">${phaseCells}</div>
          <span class="history-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'">üìä Show year-by-year data</span>
          <div class="history-detail">
            <table>
              <thead><tr><th>Year</th><th>2A</th><th>2B</th><th>2C</th><th>2C(S)</th></tr></thead>
              <tbody>${histRows}</tbody>
            </table>
            <p style="margin-top:0.5rem;color:#64748b;">Format: applicants/vacancies. ‚ö° = balloting conducted. <span style="color:#dc2626">Red</span> = oversubscribed.</p>
          </div>
        </div>`;
      }).join('');
      
      document.getElementById('schoolList').innerHTML = html;
      updatePhaseHighlight();
    }
    
    function updatePhaseHighlight() {
      const phase = document.querySelector('input[name="phase"]:checked')?.value || '2C';
      const phaseMap = { '1': 'Phase 1 ‚Äî guaranteed admission (sibling priority)', '2A': 'Phase 2A', '2B': 'Phase 2B', '2C': 'Phase 2C ‚Äî open phase, most competitive' };
      document.getElementById('phaseResult').innerHTML = `Your phase: <strong>${phaseMap[phase] || phase}</strong>. Look at the ${phase === '1' ? 'Phase 1 is guaranteed ‚Äî no balloting' : phase + ' column below'}.`;
    }
  </script>
</body>
</html>
