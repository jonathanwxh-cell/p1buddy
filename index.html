<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P1Buddy ‚Äî Singapore P1 School Registration Planner</title>
  <meta name="description" content="Enter your postal code. See your personalised odds at every nearby primary school based on citizenship and distance. Free P1 registration probability tool for Singapore parents.">
  <meta name="keywords" content="P1 registration Singapore, primary school registration, P1 balloting, school admission odds, Singapore primary school calculator, MOE P1, Phase 2C balloting">
  <meta property="og:title" content="P1Buddy ‚Äî See Your P1 School Odds">
  <meta property="og:description" content="Enter your postal code. See your personalised chances at every nearby primary school. Free tool with 3 years of MOE balloting data.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://p1buddy.com">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="P1Buddy ‚Äî Singapore P1 School Registration Planner">
  <meta name="twitter:description" content="Enter your postal code. See your personalised odds at every nearby primary school.">
  <link rel="canonical" href="https://p1buddy.com">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-59Z85V602C"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-59Z85V602C');</script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; }
    
    .hero { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 3rem 1rem 2rem; text-align: center; }
    .hero h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .hero p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 1.5rem; }
    
    .search-box { max-width: 500px; margin: 0 auto; display: flex; gap: 0.5rem; }
    .search-box input { flex: 1; padding: 0.875rem 1rem; border: none; border-radius: 0.5rem; font-size: 1rem; outline: none; }
    .search-box button { padding: 0.875rem 1.5rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .search-box button:hover { background: #d97706; }
    
    .container { max-width: 800px; margin: 0 auto; padding: 1.5rem 1rem; }
    
    .profile-section { background: white; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none; }
    .profile-section h3 { margin-bottom: 1rem; font-size: 1.1rem; }
    .profile-row { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .profile-group { flex: 1; min-width: 200px; }
    .profile-group h4 { font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem; }
    .profile-group label { display: block; padding: 0.4rem 0; cursor: pointer; font-size: 0.95rem; }
    .profile-group input[type="radio"] { margin-right: 0.5rem; }
    .profile-result { margin-top: 0.75rem; padding: 0.75rem; background: #eff6ff; border-radius: 0.5rem; font-weight: 500; font-size: 0.9rem; }
    .profile-result.warning { background: #fef3c7; color: #92400e; }
    
    .results { display: none; }
    .results h2 { margin-bottom: 0.5rem; }
    .results .subtitle { color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem; }
    
    .school-card { background: white; border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .school-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .school-name { font-size: 1.1rem; font-weight: 600; }
    .school-distance { font-size: 0.85rem; color: #64748b; }
    .distance-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
    .distance-badge.within-1km { background: #dcfce7; color: #166534; }
    .distance-badge.within-2km { background: #fef9c3; color: #854d0e; }
    .distance-badge.outside-2km { background: #fee2e2; color: #991b1b; }
    
    .personal-odds { padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem; font-size: 0.9rem; }
    .personal-odds.safe { background: #dcfce7; border: 1px solid #bbf7d0; }
    .personal-odds.moderate { background: #fef9c3; border: 1px solid #fde68a; }
    .personal-odds.risky { background: #fee2e2; border: 1px solid #fecaca; }
    .personal-odds.na { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; }
    .personal-odds strong { display: block; margin-bottom: 0.25rem; }
    
    .phase-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .phase-cell { text-align: center; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.8rem; }
    .phase-cell .label { font-weight: 600; margin-bottom: 0.25rem; }
    .phase-cell .odds { font-size: 1.1rem; font-weight: 700; }
    .phase-cell.safe { background: #dcfce7; }
    .phase-cell.moderate { background: #fef9c3; }
    .phase-cell.risky { background: #fee2e2; }
    .phase-cell.na { background: #f1f5f9; color: #94a3b8; }
    .phase-cell.highlight { outline: 2.5px solid #3b82f6; outline-offset: -1px; }
    
    .school-warning { font-size: 0.8rem; color: #92400e; background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; }
    
    .history-toggle { color: #3b82f6; cursor: pointer; font-size: 0.85rem; margin-top: 0.5rem; display: inline-block; }
    .history-detail { display: none; margin-top: 0.75rem; font-size: 0.8rem; }
    .history-detail table { width: 100%; border-collapse: collapse; }
    .history-detail th, .history-detail td { padding: 0.375rem 0.5rem; border-bottom: 1px solid #e2e8f0; text-align: center; }
    .history-detail th { background: #f8fafc; font-weight: 600; }
    
    .info-section { background: white; border-radius: 0.75rem; padding: 1.5rem; margin-top: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .info-section h3 { margin-bottom: 0.75rem; }
    .info-section p { color: #475569; font-size: 0.9rem; margin-bottom: 0.5rem; }
    
    .loading { text-align: center; padding: 2rem; display: none; }
    .loading .spinner { display: inline-block; width: 2rem; height: 2rem; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .share-bar { text-align: center; padding: 1.5rem 1rem 0; display: none; }
    .share-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 2rem; font-size: 0.95rem; font-weight: 600; text-decoration: none; color: white; }
    .share-whatsapp { background: #25D366; }
    .share-whatsapp:hover { background: #1da851; }
    .share-copy { background: #64748b; cursor: pointer; border: none; color: white; font-size: 0.95rem; font-weight: 600; }
    .share-copy:hover { background: #475569; }
    
    .footer { text-align: center; padding: 2rem 1rem; color: #94a3b8; font-size: 0.8rem; }
    .footer a { color: #3b82f6; text-decoration: none; }
    
    .disclaimer { background: #fffbeb; border: 1px solid #fde68a; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.8rem; color: #92400e; margin-bottom: 1.5rem; display: none; }

    .scenario-section { background: white; border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .scenario-section h3 { margin-bottom: 0.4rem; }
    .scenario-section p { color: #64748b; font-size: 0.9rem; margin-bottom: 0.8rem; }
    .scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .scenario-card { background:#fff; border:1px solid #e2e8f0; border-radius:0.75rem; padding:1rem; }
    .scenario-card.good { border-color:#86efac; background:#f0fdf4; }
    .scenario-card .meta { color:#475569; font-size:0.85rem; margin:0.2rem 0 0.5rem; }
    .scenario-card .pill { display:inline-block; padding:0.15rem 0.5rem; border-radius:999px; background:#e2e8f0; color:#334155; font-size:0.75rem; margin-right:0.4rem; margin-top:0.2rem; }
    .scenario-card .pill.good { background:#dcfce7; color:#166534; }
    .scenario-table { width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:0.5rem; }
    .scenario-table th,.scenario-table td { border-bottom:1px solid #e2e8f0; padding:0.3rem; text-align:center; }
    .scenario-table th { background:#f8fafc; }

    @media (max-width: 640px) {
      .scenario-grid { grid-template-columns: 1fr; }
      .hero h1 { font-size: 1.5rem; }
      .phase-grid { grid-template-columns: repeat(2, 1fr); }
      .search-box { flex-direction: column; }
      .profile-row { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>üéí P1Buddy</h1>
    <p>Enter your postal code. See how competitive every nearby school has been ‚Äî for your situation.</p>
    <div class="search-box">
      <input type="text" id="postalInput" placeholder="Enter postal code (e.g. 569930)" maxlength="6" inputmode="numeric">
      <button id="searchBtn" onclick="search()">Find Schools</button>
    </div>
    <p style="margin-top:1rem;font-size:0.95rem;opacity:0.95;"><a href="#moveScenario" style="color:#fef3c7;font-weight:600;text-decoration:underline;">üè° What if I move? Explore another postal code</a></p>
  </div>
  
  <div class="container">
    <div class="scenario-section" id="moveScenario">
      <h3>üè° What if I move?</h3>
      <p>Try any Singapore postal code and see schools within <strong>1km</strong> and <strong>1-2km</strong> with historical Phase 2C competitiveness.</p>
      <div class="search-box" style="max-width:none;">
        <input type="text" id="scenarioPostalInput" placeholder="Try another postal code (e.g. 238801)" maxlength="6" inputmode="numeric">
        <button onclick="runMoveScenario()">Run scenario</button>
      </div>
      <div id="scenarioSummary" style="margin-top:0.75rem;color:#475569;font-size:0.9rem;"></div>
      <div id="scenarioResults" class="scenario-grid" style="margin-top:0.8rem;"></div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top:1rem;color:#64748b;">Finding schools near you...</p>
    </div>
    
    <div class="disclaimer" id="disclaimer">
      ‚ö†Ô∏è Based on historical data from 2022-2024. Actual results may vary. Distances shown are straight-line estimates ‚Äî MOE uses walking distance to the school's nearest gate, which may differ. Always verify with <a href="https://www.onemap.gov.sg/school-query" target="_blank">OneMap</a> or <a href="https://www.moe.gov.sg/primary/p1-registration" target="_blank">MOE's official tools</a>.
    </div>

    <div class="profile-section" id="profileSection">
      <h3>Tell us about your child</h3>
      <div class="profile-row">
        <div class="profile-group">
          <h4>Citizenship</h4>
          <label><input type="radio" name="citizenship" value="SC" onchange="refreshResults()" checked> üá∏üá¨ Singapore Citizen</label>
          <label><input type="radio" name="citizenship" value="PR" onchange="refreshResults()"> Permanent Resident (PR)</label>
        </div>
        <div class="profile-group">
          <h4>Registration Phase</h4>
          <label><input type="radio" name="phase" value="1" onchange="refreshResults()"> <strong>Phase 1</strong> ‚Äî Sibling in school</label>
          <label><input type="radio" name="phase" value="2A" onchange="refreshResults()"> <strong>Phase 2A</strong> ‚Äî Alumni / staff / advisory committee / MOE Kindergarten</label>
          <label><input type="radio" name="phase" value="2B" onchange="refreshResults()"> <strong>Phase 2B</strong> ‚Äî Volunteer / church-clan / community leader</label>
          <label><input type="radio" name="phase" value="2C" onchange="refreshResults()" checked> <strong>Phase 2C</strong> ‚Äî Open to all SC/PR</label>
        </div>
      </div>
      <div class="profile-result" id="profileResult"></div>
    </div>
    
    <div class="results" id="results">
      <h2>Nearby Primary Schools</h2>
      <p class="subtitle" id="resultsSubtitle"></p>
      <div id="schoolList"></div>
    </div>
    
    <div class="share-bar" id="shareBar">
      <p style="color:#64748b;margin-bottom:0.75rem;font-size:0.9rem;">Know other parents stressing about P1? Share this tool üëá</p>
      <a class="share-btn share-whatsapp" href="#" id="whatsappShare" target="_blank">üì± Share on WhatsApp</a>
      &nbsp;
      <button class="share-btn share-copy" onclick="copyLink()">üìã Copy Link</button>
    </div>
    
    <div class="info-section">
      <h3>How does P1 registration work?</h3>
      <p>Singapore P1 registration runs in phases from July-August each year. Priority is given first by phase (sibling > alumni > volunteer > open), then by <strong>citizenship</strong> (SC > PR), then by <strong>distance</strong> (within 1km > 1-2km > outside 2km).</p>
      <p>When more applicants than vacancies exist, MOE conducts computerized balloting within each priority group. A Singapore Citizen living outside 2km is prioritised over a PR living within 1km.</p>
      <p><strong>This tool uses 3 years of historical data (2022-2024)</strong> to show your personalised odds based on your citizenship and distance to each school.</p>
    </div>

    <div class="info-section" style="margin-top:1rem;">
      <h3>Understanding the priority order</h3>
      <p>Within each phase, when balloting is needed, places are allocated in this order:</p>
      <ol style="padding-left:1.5rem;margin:0.75rem 0;color:#475569;font-size:0.9rem;">
        <li>üá∏üá¨ SC within 1km</li>
        <li>üá∏üá¨ SC between 1-2km</li>
        <li>üá∏üá¨ SC outside 2km</li>
        <li>PR within 1km</li>
        <li>PR between 1-2km</li>
        <li>PR outside 2km</li>
      </ol>
      <p style="margin-top:0.5rem;">This means citizenship matters more than distance. A PR within 1km still queues behind all SCs.</p>
    </div>

    <div class="info-section" style="margin-top:1rem;">
      <h3>‚ö†Ô∏è Important rules to know</h3>
      <p><strong>30-month stay requirement:</strong> If your child gains admission through distance priority, your family must continue living at the registered address for at least 30 months from the start of registration (1 July). Failing this may result in transfer to another school.</p>
      <p><strong>Distance measurement:</strong> MOE measures walking distance to the school's nearest pedestrian gate ‚Äî not straight-line distance. This tool uses straight-line estimates which may differ. Always verify with <a href="https://www.onemap.gov.sg" target="_blank">OneMap</a> or MOE's calculator.</p>
      <p><strong>Phase 2C Supplementary:</strong> Only for children still unplaced after Phase 2C. If your child secures a spot in 2C, you cannot register again in 2C(S) at a different school.</p>
    </div>
  </div>
  
  <div class="footer">
    <p>üìñ <a href="/guide.html">Complete P1 Registration Guide</a> ¬∑ üìã <a href="/changelog.html">Changelog</a></p>
    <p>P1Buddy is a free tool. Not affiliated with MOE.</p>
    <p>Data from <a href="https://www.moe.gov.sg/primary/p1-registration" target="_blank">MOE</a> and <a href="https://www.onemap.gov.sg" target="_blank">OneMap</a>.</p>
  </div>

  <script>
    let schoolsData = null;
    let userLat = null, userLng = null;
    let lastPostal = null;
    
    // Priority order: SC<1=1, SC1-2=2, SC>2=3, PR<1=4, PR1-2=5, PR>2=6
    const PRIORITY_ORDER = {
      'SC<1': 1, 'SC1-2': 2, 'SC<2': 1, 'SC>2': 3, 'SC': 3,
      'PR<1': 4, 'PR1-2': 5, 'PR<2': 4, 'PR>2': 6, 'PR': 6,
      // Handle variants with # suffix (partial ballot)
      'SC<1#': 1, 'SC1-2#': 2, 'SC<2#': 1, 'SC>2#': 3, 'SC#': 3,
      'PR<1#': 4, 'PR1-2#': 5, 'PR<2#': 4, 'PR>2#': 6, 'PR#': 6
    };
    
    function getDistanceBandForSchool(distance) {
      if (distance <= 1000) return 'within-1km';
      if (distance <= 2000) return 'within-2km';
      return 'outside-2km';
    }
    
    function getUserPriorityForSchool(distance) {
      const cit = document.querySelector('input[name="citizenship"]:checked')?.value || 'SC';
      const band = getDistanceBandForSchool(distance);
      if (cit === 'SC') {
        if (band === 'within-1km') return 1;
        if (band === 'within-2km') return 2;
        return 3;
      } else {
        if (band === 'within-1km') return 4;
        if (band === 'within-2km') return 5;
        return 6;
      }
    }
    
    function priorityLabel(p) {
      const labels = { 1: 'SC within 1km', 2: 'SC 1-2km', 3: 'SC outside 2km', 4: 'PR within 1km', 5: 'PR 1-2km', 6: 'PR outside 2km' };
      return labels[p] || 'Unknown';
    }
    
    function humanBallotInfo(code) {
      if (!code) return '';
      const map = {
        'SC<1': 'SC ‚â§1km balloted', 'SC1-2': 'SC 1-2km balloted', 'SC>2': 'SC >2km balloted',
        'SC<2': 'SC ‚â§2km balloted', 'SC': 'All SC balloted',
        'PR<1': 'PR ‚â§1km balloted', 'PR1-2': 'PR 1-2km balloted', 'PR>2': 'PR >2km balloted',
        'PR<2': 'PR ‚â§2km balloted', 'PR': 'All PR balloted'
      };
      const base = code.replace(/#.*$/, '');
      const partial = code.includes('#') ? '*' : '';
      return (map[base] || code) + partial;
    }

    // Load data
    fetch('data/schools-combined.json')
      .then(r => r.json())
      .then(d => { schoolsData = d; })
      .catch(e => console.error('Failed to load school data:', e));
    
    document.getElementById('postalInput').addEventListener('input', e => {
      e.target.value = normalizePostalInput(e.target.value);
    });
    document.getElementById('postalInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') search();
    });
    document.getElementById('scenarioPostalInput').addEventListener('input', e => {
      e.target.value = normalizePostalInput(e.target.value);
    });
    document.getElementById('scenarioPostalInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') runMoveScenario();
    });
    
    function normalizePostalInput(value) {
      return String(value || '').replace(/\D/g, '').slice(0, 6);
    }

    async function search() {
      const input = document.getElementById('postalInput');
      const postal = normalizePostalInput(input.value);
      input.value = postal;
      if (postal.length !== 6) {
        alert('Please enter a valid 6-digit postal code');
        return;
      }
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('results').style.display = 'none';
      
      try {
        const res = await fetch(`https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${postal}&returnGeom=Y&getAddrDetails=Y&pageNum=1`);
        const data = await res.json();
        
        if (!data.found || data.found === 0) {
          alert('Postal code not found. Please check and try again.');
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        userLat = parseFloat(data.results[0].LATITUDE);
        userLng = parseFloat(data.results[0].LONGITUDE);
        lastPostal = postal;
        
        displayResults(postal);
      } catch(e) {
        alert('Error looking up postal code. Please try again.');
        console.error(e);
      }
      
      document.getElementById('loading').style.display = 'none';
    }
    
    function refreshResults() {
      if (lastPostal && userLat && userLng) {
        displayResults(lastPostal);
      }
      updateProfileResult();
    }
    
    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function getPhase2CScore(school) {
      let count = 0;
      let totalVacancyDelta = 0;
      for (const phases of Object.values(school.history || {})) {
        const d = phases['2C'];
        if (!d) continue;
        count++;
        totalVacancyDelta += (d.vacancies || 0) - (d.applicants || 0);
      }
      if (!count) return -9999;
      return totalVacancyDelta / count;
    }

    function getAvailablePhases(school) {
      const set = new Set();
      for (const phases of Object.values(school.history || {})) {
        for (const k of Object.keys(phases || {})) set.add(k);
      }
      const ordered = ['1','2A','2B','2C','2CS'];
      return ordered.filter(k => set.has(k)).map(k => (k === '2CS' ? '2C(S)' : k));
    }

    async function geocodePostal(postal) {
      const res = await fetch(`https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${postal}&returnGeom=Y&getAddrDetails=Y&pageNum=1`);
      const data = await res.json();
      if (!data.found || data.found === 0) return null;
      return {
        lat: parseFloat(data.results[0].LATITUDE),
        lng: parseFloat(data.results[0].LONGITUDE)
      };
    }

    function renderScenarioCard(s) {
      const dist = (s.distance / 1000).toFixed(2);
      const in1km = s.distance <= 1000;
      const phase2cScore = getPhase2CScore(s);
      const goodChance = phase2cScore >= 15;
      const phases = getAvailablePhases(s).map(p => `<span class="pill">${p}</span>`).join('');

      const years = Object.keys(s.history || {}).sort();
      const rows = years.map(y => {
        const d = s.history[y]?.['2C'];
        if (!d) return '';
        const status = d.oversubscribed ? '‚ö†Ô∏è Ballot' : '‚úÖ No ballot';
        return `<tr><td>${y}</td><td>${d.vacancies ?? '-'}</td><td>${d.applicants ?? '-'}</td><td>${status}</td></tr>`;
      }).join('');

      return `<div class="scenario-card ${goodChance ? 'good' : ''}">
        <div style="display:flex;justify-content:space-between;gap:0.5rem;align-items:flex-start;">
          <strong>${s.name} Primary School</strong>
          <span class="pill ${goodChance ? 'good' : ''}">${goodChance ? 'Good 2C history' : 'Tighter 2C history'}</span>
        </div>
        <div class="meta">${dist} km ¬∑ ${in1km ? 'Within 1km' : '1-2km'}</div>
        <div>${phases}</div>
        <table class="scenario-table">
          <thead><tr><th>Year</th><th>2C Vac</th><th>2C Apps</th><th>Outcome</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    }

    async function runMoveScenario() {
      const input = document.getElementById('scenarioPostalInput');
      const postal = normalizePostalInput(input.value);
      input.value = postal;
      if (postal.length !== 6) {
        alert('Please enter a valid 6-digit postal code');
        return;
      }
      if (!schoolsData) {
        alert('School data still loading, please wait a moment.');
        return;
      }

      const point = await geocodePostal(postal);
      if (!point) {
        alert('Postal code not found. Please check and try again.');
        return;
      }

      const all = schoolsData.map(s => ({ ...s, distance: haversine(point.lat, point.lng, s.lat, s.lng) }));
      const within1 = all.filter(s => s.distance <= 1000).sort((a,b)=>a.distance-b.distance);
      const within2 = all.filter(s => s.distance > 1000 && s.distance <= 2000).sort((a,b)=>a.distance-b.distance);
      const picked = [...within1, ...within2];

      document.getElementById('scenarioSummary').innerHTML = `${within1.length} school(s) within 1km ¬∑ ${within2.length} school(s) within 1-2km of <strong>${postal}</strong>. Sorted by distance.`;
      document.getElementById('scenarioResults').innerHTML = picked.map(renderScenarioCard).join('') || '<div style="color:#64748b;">No schools found within 2km.</div>';
    }
    
    function getPersonalisedOdds(school, phase, distance) {
      const years = school.history;
      const userPri = getUserPriorityForSchool(distance);
      const cit = document.querySelector('input[name="citizenship"]:checked')?.value || 'SC';
      
      let safeYears = 0, ballotYears = 0, cutoffYears = 0, totalYears = 0;
      
      for (const [year, phases] of Object.entries(years)) {
        const phaseData = phases[phase];
        if (!phaseData) continue;
        
        // 0 vacancies + 0 applicants = school filled before this phase
        if (phaseData.vacancies === 0 && phaseData.applicants === 0) {
          totalYears++;
          cutoffYears++; // School was full ‚Äî no chance in this phase
          continue;
        }
        
        totalYears++;
        
        if (!phaseData.oversubscribed) {
          safeYears++; // Everyone got in
          continue;
        }
        
        // Oversubscribed ‚Äî check where the ballot cutoff was
        const ballotInfo = phaseData.ballotInfo;
        if (!ballotInfo) {
          ballotYears++; // Oversubscribed but no cutoff info
          continue;
        }
        
        const cutoffPri = PRIORITY_ORDER[ballotInfo];
        if (cutoffPri === undefined) {
          ballotYears++; // Unknown format
          continue;
        }
        
        if (userPri < cutoffPri) {
          safeYears++; // User's priority is higher than cutoff ‚Äî they got in before ballot
        } else if (userPri === cutoffPri) {
          ballotYears++; // User was in the ballot group
        } else {
          cutoffYears++; // User didn't even get considered
        }
      }
      
      if (totalYears === 0) return { class: 'na', emoji: 'N/A', label: 'No data', desc: 'No historical data available' };
      
      // All years safe
      if (safeYears === totalYears) {
        return { class: 'safe', emoji: 'üü¢', label: 'Comfortable', desc: `Historically, ${priorityLabel(userPri)} got in all ${totalYears} years without balloting` };
      }
      
      // Mostly cut off
      if (cutoffYears === totalYears) {
        return { class: 'risky', emoji: 'üî¥', label: 'Unlikely', desc: `Historically filled before ${cit} ${distance<=1000?'<1km':distance<=2000?'1-2km':'>2km'} were considered ‚Äî all ${totalYears} years` };
      }
      
      if (cutoffYears > 0 && ballotYears === 0 && safeYears === 0) {
        return { class: 'risky', emoji: 'üî¥', label: 'Unlikely', desc: `Historically, places filled before your priority group in all ${totalYears} years` };
      }
      
      // Mix of ballot + cutoff
      if (cutoffYears > 0) {
        return { class: 'risky', emoji: 'üî¥', label: 'Tough', desc: `Historically: not reached ${cutoffYears}/${totalYears}yr, balloted ${ballotYears}/${totalYears}yr` };
      }
      
      // Some ballot years, no cutoff
      if (ballotYears === totalYears) {
        return { class: 'moderate', emoji: 'üü°', label: 'Competitive', desc: `Would have needed to ballot every year (${totalYears}yr)` };
      }
      
      if (ballotYears > 0) {
        return { class: 'moderate', emoji: 'üü°', label: 'Mixed', desc: `Historically: no ballot ${safeYears}yr, needed ballot ${ballotYears}yr out of ${totalYears}` };
      }
      
      return { class: 'safe', emoji: 'üü¢', label: 'Comfortable', desc: `Historically got in ${safeYears}/${totalYears} years without balloting` };
    }
    
    function getGenericOdds(school, phase) {
      const years = school.history;
      let oversubCount = 0, totalYears = 0, filledCount = 0;
      
      for (const [year, phases] of Object.entries(years)) {
        const phaseData = phases[phase];
        if (!phaseData) continue;
        
        // 0/0 = school filled before this phase
        if (phaseData.vacancies === 0 && phaseData.applicants === 0) {
          totalYears++;
          filledCount++;
          continue;
        }
        
        totalYears++;
        if (phaseData.oversubscribed) oversubCount++;
      }
      
      if (totalYears === 0) return { class: 'na', label: 'N/A', desc: 'No data' };
      
      // For 2CS, filled = no spots available = risky
      const totalBad = oversubCount + filledCount;
      
      if (totalBad === 0) return { class: 'safe', label: 'üü¢', desc: `No balloting in ${totalYears}yr` };
      
      if (filledCount > 0 && filledCount === totalYears) {
        return { class: 'risky', label: 'üî¥', desc: `Full before 2C(S) all ${totalYears}yr` };
      }
      
      if (totalBad < totalYears) {
        let parts = [];
        if (oversubCount > 0) parts.push(`balloted ${oversubCount}yr`);
        if (filledCount > 0) parts.push(`full ${filledCount}yr`);
        return { class: 'moderate', label: 'üü°', desc: `${parts.join(', ')} of ${totalYears}` };
      }
      
      return { class: 'risky', label: 'üî¥', desc: `Oversubscribed every year (${totalYears}yr)` };
    }
    
    function displayResults(postal) {
      if (!schoolsData) {
        alert('School data still loading, please wait...');
        return;
      }
      
      const selectedPhase = document.querySelector('input[name="phase"]:checked')?.value || '2C';
      const cit = document.querySelector('input[name="citizenship"]:checked')?.value || 'SC';
      
      const withDistance = schoolsData.map(s => ({
        ...s,
        distance: haversine(userLat, userLng, s.lat, s.lng)
      })).sort((a, b) => a.distance - b.distance);
      
      const nearby = withDistance.filter(s => s.distance <= 2000);
      const extra = withDistance.filter(s => s.distance > 2000).slice(0, 5);
      const display = [...nearby, ...extra];
      
      document.getElementById('disclaimer').style.display = 'block';
      document.getElementById('profileSection').style.display = 'block';
      document.getElementById('results').style.display = 'block';
      document.getElementById('resultsSubtitle').textContent = 
        `${nearby.length} schools within 2km of postal code ${postal} ¬∑ Showing odds for ${cit === 'SC' ? 'üá∏üá¨ Singapore Citizen' : 'PR'}`;
      
      updateProfileResult();
      
      const phaseForOdds = selectedPhase === '1' ? null : selectedPhase;
      
      const html = display.map((s, idx) => {
        const distKm = (s.distance / 1000).toFixed(2);
        const band = getDistanceBandForSchool(s.distance);
        const bandLabel = band === 'within-1km' ? 'Within 1km' : band === 'within-2km' ? '1-2km' : 'Outside 2km';
        const bandClass = band;
        
        // Personalised odds for selected phase
        let personalHtml = '';
        if (selectedPhase === '1') {
          personalHtml = `<div class="personal-odds safe"><strong>Phase 1 ‚Äî Sibling priority</strong>Virtually guaranteed ‚Äî balloting is extremely rare in Phase 1. Historical Phase 1 data not tracked by this tool.</div>`;
        } else {
          const personalOdds = getPersonalisedOdds(s, selectedPhase, s.distance);
          personalHtml = `<div class="personal-odds ${personalOdds.class}">
            <strong>${personalOdds.emoji} Your outlook (Phase ${selectedPhase === '2CS' ? '2C(S)' : selectedPhase}, ${cit}, ${bandLabel}): ${personalOdds.label}</strong>
            ${personalOdds.desc}
          </div>`;
        }
        
        // Warning for Phase 2B community leaders >2km
        let warningHtml = '';
        if (selectedPhase === '2B' && s.distance > 2000) {
          warningHtml = `<div class="school-warning">‚ö†Ô∏è Note: Endorsed community leaders can only register for schools within 2km in Phase 2B. Parent volunteers and church/clan members are not restricted by distance.</div>`;
        }
        
        // Phase grid (generic odds for all phases)
        const phases = ['2A', '2B', '2C', '2CS'];
        const phaseCells = phases.map(p => {
          const odds = getGenericOdds(s, p);
          const isSelected = p === selectedPhase || (p === '2CS' && selectedPhase === '2CS');
          return `<div class="phase-cell ${odds.class}${isSelected ? ' highlight' : ''}">
            <div class="label">${p === '2CS' ? '2C(S)' : p}</div>
            <div class="odds">${odds.label}</div>
            <div style="font-size:0.7rem;margin-top:0.15rem;">${odds.desc}</div>
          </div>`;
        }).join('');
        
        // History table
        const years = Object.keys(s.history).sort();
        const histRows = years.map(y => {
          const cols = phases.map(p => {
            const d = s.history[y]?.[p];
            if (!d) return '<td>-</td>';
            // 0/0 = school was full before this phase
            if (d.vacancies === 0 && d.applicants === 0) {
              return '<td style="color:#dc2626;font-weight:600">Full</td>';
            }
            const style = d.oversubscribed ? 'color:#dc2626;font-weight:600' : 'color:#16a34a';
            const ballotDetail = d.ballotInfo ? ` <span style="font-size:0.65rem;color:#64748b;">${humanBallotInfo(d.ballotInfo)}</span>` : '';
            return `<td style="${style}">${d.applicants}/${d.vacancies}${d.balloted ? ' ‚ö°' : ''}${ballotDetail}</td>`;
          }).join('');
          return `<tr><td><strong>${y}</strong></td>${cols}</tr>`;
        }).join('');
        
        return `<div class="school-card">
          <div class="school-header">
            <div>
              <div class="school-name">${s.name} Primary School</div>
              <div class="school-distance">${distKm} km away (straight-line)</div>
            </div>
            <span class="distance-badge ${bandClass}">${bandLabel}</span>
          </div>
          ${personalHtml}
          ${warningHtml}
          <div class="phase-grid">${phaseCells}</div>
          <span class="history-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'">üìä Show year-by-year data</span>
          <div class="history-detail">
            <table>
              <thead><tr><th>Year</th><th>2A</th><th>2B</th><th>2C</th><th>2C(S)</th></tr></thead>
              <tbody>${histRows}</tbody>
            </table>
            <p style="margin-top:0.5rem;color:#64748b;">Format: applicants/vacancies. ‚ö° = balloting. <span style="color:#64748b;font-size:0.75rem;">Ballot cutoff code</span> shows where the queue stopped (e.g. SC<1 = SCs within 1km had to ballot). <span style="color:#dc2626">Red</span> = oversubscribed.</p>
          </div>
        </div>`;
      }).join('');
      
      document.getElementById('schoolList').innerHTML = html;
      
      // Share bar
      document.getElementById('shareBar').style.display = 'block';
      const shareUrl = postal ? `https://p1buddy.com?postal=${postal}` : 'https://p1buddy.com';
      const shareText = encodeURIComponent(`P1 registration stress? üò∞ I just found this free tool that shows your actual chances at every school near you! No more guessing ‚Äî see 3 years of balloting data and personalised odds based on your citizenship and distance. Total game-changer for P1 planning! üéí ${shareUrl}`);
      document.getElementById('whatsappShare').href = `https://wa.me/?text=${shareText}`;
    }
    
    function updateProfileResult() {
      const phase = document.querySelector('input[name="phase"]:checked')?.value || '2C';
      const cit = document.querySelector('input[name="citizenship"]:checked')?.value || 'SC';
      const el = document.getElementById('profileResult');
      
      const phaseNames = {
        '1': 'Phase 1 ‚Äî guaranteed (sibling priority)',
        '2A': 'Phase 2A ‚Äî alumni / staff / advisory committee / MOE Kindergarten',
        '2B': 'Phase 2B ‚Äî volunteer / church-clan / community leader',
        '2C': 'Phase 2C ‚Äî open to all, most competitive'
      };
      
      let msg = `<strong>${cit === 'SC' ? 'üá∏üá¨ Singapore Citizen' : 'Permanent Resident'}</strong> registering in <strong>${phaseNames[phase] || phase}</strong>.`;
      
      if (cit === 'PR') {
        msg += `<br><span style="font-size:0.85rem;">As a PR, you'll queue behind all SCs in your distance band during balloting.</span>`;
        el.className = 'profile-result warning';
      } else {
        el.className = 'profile-result';
      }
      
      if (phase === '1') {
        msg += `<br><span style="font-size:0.85rem;">Phase 1 is practically guaranteed ‚Äî very rarely oversubscribed.</span>`;
      }
      
      el.innerHTML = msg;
    }
    
    function copyLink() {
      const postal = document.getElementById('postalInput')?.value;
      const url = postal ? `https://p1buddy.com?postal=${postal}` : 'https://p1buddy.com';
      navigator.clipboard.writeText(url).then(() => {
        const btn = event.target;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = 'üìã Copy Link', 2000);
      });
    }
    
    // Check for URL parameters on page load
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const postalParam = urlParams.get('postal');
      
      if (postalParam && /^\d{6}$/.test(postalParam)) {
        document.getElementById('postalInput').value = postalParam;
        setTimeout(() => {
          document.getElementById('searchBtn').click();
        }, 500);
      }
    });
  </script>
</body>
</html>
